blueprint:
  name: SmInt - Universal MQTT Device Generator
  description: Erstellt Sensoren und loggt Verbräuche für SmInt TR-K Reader.
  domain: automation
  input:
    switch_entity:
      name: Auslöser-Schalter
      description: z.B. input_boolean.tr_k_02_switch_tag_001
      selector:
        entity:
          domain: input_boolean
    
    name_entity:
      name: Experiment Name
      description: z.B. input_text.experiment_tag001
      selector:
        entity:
          domain: input_text
          
    value_entity:
      name: Messwert (Verbrauch)
      description: z.B. input_number.tr_k_02_kwh_um_added_tag001
      selector:
        entity:
          domain: input_number

    reader_id_string:
      name: Reader ID (MQTT Topic)
      description: "tr_k_01_kwh" oder "tr_k_02_kwh"
      default: "tr_k_01_kwh"

    device_friendly_name:
      name: Anzeigename
      description: z.B. "03_Mikrowelle Stromverbrauch"
      default: "SmInt Device"
    
    manufacturer_name:
      name: Hersteller (Karte)
      description: z.B. "Karte 001"
      default: "SmInt Generic"

variables:
  var_name_entity: !input name_entity
  var_value_entity: !input value_entity
  var_friendly_name: !input device_friendly_name
  var_manufacturer: !input manufacturer_name
  var_reader_id: !input reader_id_string

trigger:
  - platform: state
    entity_id: !input switch_entity
    from: "off"
    to: "on"
    id: "turn_on"
  - platform: state
    entity_id: !input switch_entity
    from: "on"
    to: "off"
    id: "turn_off"

action:
  - choose:
      # AN: Config senden
      - conditions:
          - condition: trigger
            id: "turn_on"
        sequence:
          - service: mqtt.publish
            data:
              topic: "homeassistant/sensor/{{ states(var_name_entity) }}/{{ var_reader_id }}/config"
              retain: true
              qos: 0
              payload: >
                {
                  "name": "{{ var_friendly_name }}",
                  "state_topic": "homeassistant/sensor/{{ states(var_name_entity) }}/{{ var_reader_id }}/state",
                  "unit_of_measurement": "kWh",
                  "device_class": "energy",
                  "state_class": "total",
                  "unique_id": "{{ states(var_name_entity) }}_{{ var_reader_id }}",
                  "device": {
                    "identifiers": ["{{ states(var_name_entity) }}"],
                    "name": "{{ states(var_name_entity) }}",
                    "manufacturer": "{{ var_manufacturer }}",
                    "model": "SmInt",
                    "model_id": "SmInt_v1",
                    "sw_version": "2105.1.0"
                  }
                }

      # AUS: Wert senden
      - conditions:
          - condition: trigger
            id: "turn_off"
        sequence:
          - delay: 1 
          - service: mqtt.publish
            data:
              topic: "homeassistant/sensor/{{ states(var_name_entity) }}/{{ var_reader_id }}/state"
              retain: true
              qos: 0
              payload: "{{ states(var_value_entity) }}"
